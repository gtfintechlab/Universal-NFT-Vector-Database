name: Firebase Function Deploy
on:
  push:
    branches: [main]
    # paths:
    #   - "server/**"

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@master

      - name: Install Dependencies
        run: |
          cd server
          npm install
          cd ..

      - name: Create Env File
        run: |
          cd server
          touch .env
          echo AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }} >> .env
          echo AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }} >> .env
          echo JOB_SQS_URL=${{ secrets.JOB_SQS_URL }} >> .env
          cd ..

      - name: Create Firebase Credentials File
        uses: "finnp/create-file-action@76e2826db048c29ab0955dd7728016657363fb3a"
        env:
          FILE_NAME: "server/firebase_credentials.json"
          FILE_DATA: ${{ secrets.FIREBASE_CREDENTIALS }}

      - name: Build
        run: |
          cd server 
          npm run build
          cd ..

      - name: Archive Production Artifact
        uses: actions/upload-artifact@master
        with:
          name: dist
          path: dist

  deploy:
    name: Deploy
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@master

      - name: Download Artifact
        uses: actions/download-artifact@master
        with:
          name: dist
          path: dist

      - name: Deploy to Firebase
        uses: w9jds/firebase-action@master
        with:
          args: deploy --only functions:api
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
          PROJECT_PATH: ./server
